@page "/quiz"
@inject QuizDataService DataService
@inject QuizStateService State
@inject MatchingService Matching
@inject LocalizationService L
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Quiz â€“ Wal-O-Mat</PageTitle>

@if (_isLoading)
{
    <div class="loading">@L.Get("quiz_loading")</div>
}
else if (State.Phase == QuizPhase.Answering && State.CurrentQuestion is not null)
{
    <div class="quiz-container">
        <header class="quiz-header">
            <span class="progress">@L.Get("quiz_question") @(State.CurrentQuestionIndex + 1) @L.Get("quiz_of") @State.TotalQuestions</span>
            <div class="progress-bar">
                <div class="progress-fill" style="width: @(((State.CurrentQuestionIndex + 1) / (double)State.TotalQuestions) * 100)%"></div>
            </div>
        </header>

        <main class="question-area">
            <p class="question-text">@GetQuestionText()</p>

            <div class="answer-buttons">
                <button class="answer-btn agree @(GetAnswerClass(1))" @onclick="() => Answer(1)">
                    @L.Get("quiz_agree")
                </button>
                <button class="answer-btn neutral @(GetAnswerClass(0))" @onclick="() => Answer(0)">
                    @L.Get("quiz_neutral")
                </button>
                <button class="answer-btn disagree @(GetAnswerClass(-1))" @onclick="() => Answer(-1)">
                    @L.Get("quiz_disagree")
                </button>
            </div>

            <button class="skip-btn" @onclick="Skip">
                @L.Get("quiz_skip")
            </button>
        </main>

        <footer class="quiz-nav">
            @if (State.CurrentQuestionIndex > 0)
            {
                <button class="nav-btn" @onclick="Previous">@L.Get("quiz_back")</button>
            }
            else
            {
                <span></span>
            }
            
            @if (_hasAnswered)
            {
                <button class="nav-btn primary" @onclick="Next">
                    @(State.IsLastQuestion ? L.Get("quiz_to_weighting") : L.Get("quiz_next"))
                </button>
            }
        </footer>
    </div>
}
else if (State.Phase == QuizPhase.Weighting)
{
    <WeightingPhase OnComplete="FinishWeighting" />
}
else if (State.Phase == QuizPhase.WhaleSelection)
{
    <WhaleSelectionPhase OnComplete="ShowResults" />
}
else if (State.Phase == QuizPhase.Results && State.Results is not null)
{
    <ResultsPhase />
}

@code {
    private bool _isLoading = true;
    private bool _hasAnswered => State.GetAnswerForQuestion(State.CurrentQuestion?.Id ?? "") is not null;

    protected override async Task OnInitializedAsync()
    {
        L.OnLanguageChanged += StateHasChanged;
        var data = await DataService.LoadQuizDataAsync();
        State.Initialize(data);
        State.StartQuiz();
        _isLoading = false;
    }

    private string GetQuestionText()
    {
        if (State.CurrentQuestion is null) return "";
        return State.CurrentQuestion.GetText(L.CurrentLanguage);
    }

    private void Answer(int position)
    {
        State.AnswerQuestion(position);
        StateHasChanged();
    }

    private void Skip()
    {
        State.AnswerQuestion(null);
        Next();
    }

    private void Next()
    {
        State.NextQuestion();
    }

    private void Previous()
    {
        State.PreviousQuestion();
    }

    private void FinishWeighting()
    {
        State.FinishWeighting();
    }

    private void ShowResults()
    {
        State.CalculateResults(Matching);
    }

    private string GetAnswerClass(int position)
    {
        var current = State.GetAnswerForQuestion(State.CurrentQuestion?.Id ?? "");
        return current == position ? "selected" : "";
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= StateHasChanged;
    }
}
