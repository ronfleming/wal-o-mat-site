@inject QuizStateService State
@inject LocalizationService L
@inject NavigationManager Navigation
@inject ShareService Share
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="results-container">
    <header>
        <h2>@L.Get("results_title")</h2>
        <p>@L.Get("results_intro")</p>
    </header>

    @if (IsAllNeutral())
    {
        <!-- Dugong Easter Egg -->
        <div class="dugong-reveal">
            <div class="dugong-card">
                <span class="dugong-emoji">ðŸ¦­</span>
                <h3>@L.Get("dugong_title")</h3>
                <p class="dugong-description">@L.Get("dugong_description")</p>
                <div class="dugong-traits">@L.Get("dugong_traits")</div>
            </div>
        </div>
    }
    else
    {
        <div class="results-list">
            @if (State.Results is not null && State.QuizData is not null)
            {
                var rank = 1;
                @foreach (var result in State.Results)
                {
                    var whale = State.QuizData.Whales.FirstOrDefault(w => w.Id == result.WhaleId);
                    var displayName = whale?.GetName(L.CurrentLanguage) ?? result.WhaleName;
                    
                    <div class="result-card @(rank == 1 ? "top-match" : "")">
                        <span class="rank">#@rank</span>
                        <img src="@result.ImagePath" alt="@displayName" />
                        <div class="result-info">
                            <span class="whale-name">@displayName</span>
                            <div class="match-bar">
                                <div class="match-fill" style="width: @result.MatchPercentage%"></div>
                            </div>
                            <span class="match-percent">@result.MatchPercentage%</span>
                            @if (rank == 1)
                            {
                                <span class="match-flavor">@GetMatchFlavorText(result.MatchPercentage)</span>
                            }
                        </div>
                    </div>
                    rank++;
                }
            }
        </div>
    }

    @if (!string.IsNullOrEmpty(_shareUrl))
    {
        <div class="share-url-container">
            <strong style="color: var(--color-accent); margin-bottom: 0.5rem;">ðŸŽ‰ @L.Get("share_success")</strong>
            <input type="text" readonly value="@_shareUrl" class="share-url-input" @ref="_shareUrlInput" @onclick="SelectAll" />
            <button class="secondary-btn" @onclick="CopyShareUrl" style="align-self: center;">
                @(_copied ? L.Get("share_copied") : L.Get("share_copy"))
            </button>
        </div>
    }

    <footer>
        @if (_shareError)
        {
            <p style="color: var(--color-disagree); font-size: 0.9rem; margin-bottom: 0.5rem;">
                @L.Get("share_error")
            </p>
        }

        @if (string.IsNullOrEmpty(_shareUrl))
        {
            <button class="primary-btn" @onclick="ShareResults" disabled="@_isSharing">
                @(_isSharing ? L.Get("share_saving") : L.Get("share_results"))
            </button>
        }
        
        <button class="secondary-btn" @onclick="Restart">
            @L.Get("results_restart")
        </button>
        <button class="secondary-btn" @onclick="GoHome">
            @L.Get("results_home")
        </button>
    </footer>
</div>

@code {
    private bool _isSharing;
    private string? _shareUrl;
    private bool _shareError;
    private bool _copied;
    private ElementReference _shareUrlInput;

    protected override void OnInitialized()
    {
        L.OnLanguageChanged += StateHasChanged;
    }

    private bool IsAllNeutral()
    {
        // Easter egg: if ALL answered questions are neutral (0), show Dugong
        var answeredQuestions = State.Answers.Where(a => a.Position.HasValue).ToList();
        if (!answeredQuestions.Any()) return false;
        return answeredQuestions.All(a => a.Position == 0);
    }

    private async Task ShareResults()
    {
        if (State.Results == null || State.QuizData == null) return;

        _isSharing = true;
        StateHasChanged();

        _shareError = false;

        try
        {
            var request = new SaveResultRequest
            {
                Language = L.CurrentLanguage,
                Answers = State.Answers.Select(a => new AnswerDto
                {
                    QuestionId = a.QuestionId,
                    Position = a.Position,
                    IsWeighted = a.IsWeighted
                }).ToList(),
                SelectedWhales = State.SelectedWhaleIds.ToList(),
                Results = State.Results.Select(r => new ResultDto
                {
                    WhaleId = r.WhaleId,
                    Percentage = r.MatchPercentage
                }).ToList()
            };

            var response = await Share.SaveResultAsync(request);
            if (response != null)
            {
                _shareUrl = response.ShareUrl;
            }
            else
            {
                _shareError = true;
            }
        }
        catch
        {
            _shareError = true;
        }
        finally
        {
            _isSharing = false;
            StateHasChanged();
        }
    }

    private void SelectAll()
    {
        JSRuntime.InvokeVoidAsync("walOMatInterop.selectAllText", _shareUrlInput);
    }

    private async Task CopyShareUrl()
    {
        // Note: Clipboard API requires HTTPS or localhost
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _shareUrl);
        _copied = true;
        StateHasChanged();
        
        // Reset after 2 seconds
        await Task.Delay(2000);
        _copied = false;
        StateHasChanged();
    }

    private void Restart()
    {
        State.Reset();
        Navigation.NavigateTo("/quiz", forceLoad: true);
    }

    private void GoHome()
    {
        State.Reset();
        Navigation.NavigateTo("/");
    }

    private string GetMatchFlavorText(double percentage)
    {
        return percentage switch
        {
            >= 90 => L.Get("results_match_90"),
            >= 70 => L.Get("results_match_70"),
            >= 50 => L.Get("results_match_50"),
            >= 30 => L.Get("results_match_30"),
            _ => L.Get("results_match_low")
        };
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= StateHasChanged;
    }
}
