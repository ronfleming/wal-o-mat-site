@inject QuizStateService State
@inject LocalizationService L
@inject NavigationManager Navigation
@implements IDisposable

<div class="results-container">
    <header>
        <h2>@L.Get("results_title")</h2>
        <p>@L.Get("results_intro")</p>
    </header>

    <div class="results-list">
        @if (State.Results is not null && State.QuizData is not null)
        {
            var rank = 1;
            @foreach (var result in State.Results)
            {
                var whale = State.QuizData.Whales.FirstOrDefault(w => w.Id == result.WhaleId);
                var displayName = whale?.GetName(L.CurrentLanguage) ?? result.WhaleName;
                
                <div class="result-card @(rank == 1 ? "top-match" : "")">
                    <span class="rank">#@rank</span>
                    <img src="@result.ImagePath" alt="@displayName" />
                    <div class="result-info">
                        <span class="whale-name">@displayName</span>
                        <div class="match-bar">
                            <div class="match-fill" style="width: @result.MatchPercentage%"></div>
                        </div>
                        <span class="match-percent">@result.MatchPercentage%</span>
                    </div>
                </div>
                rank++;
            }
        }
    </div>

    <footer>
        <button class="secondary-btn" @onclick="Restart">
            @L.Get("results_restart")
        </button>
        <button class="secondary-btn" @onclick="GoHome">
            @L.Get("results_home")
        </button>
    </footer>
</div>

@code {
    protected override void OnInitialized()
    {
        L.OnLanguageChanged += StateHasChanged;
    }

    private void Restart()
    {
        State.Reset();
        Navigation.NavigateTo("/quiz", forceLoad: true);
    }

    private void GoHome()
    {
        State.Reset();
        Navigation.NavigateTo("/");
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= StateHasChanged;
    }
}
