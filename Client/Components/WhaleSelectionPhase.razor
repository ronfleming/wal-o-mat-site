@inject QuizStateService State
@inject LocalizationService L
@implements IDisposable

<div class="selection-container">
    <header>
        <h2>@L.Get("selection_title")</h2>
        <p>@L.Get("selection_intro")</p>
    </header>

    <div class="select-all">
        <button class="link-btn" @onclick="SelectAll">@L.Get("selection_all")</button>
    </div>

    <div class="whales-grid">
        @if (State.QuizData is not null)
        {
            @foreach (var whale in State.QuizData.Whales)
            {
                var isSelected = State.SelectedWhaleIds.Contains(whale.Id);
                <div class="whale-card @(isSelected ? "selected" : "")" @onclick="() => Toggle(whale.Id)">
                    <img src="@whale.ImagePath" alt="@whale.GetName(L.CurrentLanguage)" />
                    <span class="whale-name">@whale.GetName(L.CurrentLanguage)</span>
                    <span class="check-indicator">@(isSelected ? "âœ“" : "")</span>
                </div>
            }
        }
    </div>

    <footer>
        <button class="primary-btn" @onclick="Complete" disabled="@(!HasSelection)">
            @L.Get("selection_continue")
        </button>
    </footer>
</div>

@code {
    [Parameter] public EventCallback OnComplete { get; set; }

    private bool HasSelection => State.SelectedWhaleIds.Count > 0;

    protected override void OnInitialized()
    {
        L.OnLanguageChanged += StateHasChanged;
    }

    private void Toggle(string whaleId)
    {
        State.ToggleWhaleSelection(whaleId);
    }

    private void SelectAll()
    {
        State.SelectAllWhales();
    }

    private async Task Complete()
    {
        if (HasSelection)
            await OnComplete.InvokeAsync();
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= StateHasChanged;
    }
}
